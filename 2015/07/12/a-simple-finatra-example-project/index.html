<!doctype html><html><head><title>A Simple Finatra Example Project</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><link rel=icon href=/images/favicon.ico><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css integrity=sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3 crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js integrity=sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css><style type=text/css>html,body{height:100%;padding-top:30px;padding-bottom:40px}.sidebar-nav{padding-left:18px}.navbar-right{padding-right:18px}#wrap{min-height:100%;height:auto!important;height:100%;margin:0 auto 0}#push,#footer{height:60px}#footer{background-color:#f5f5f5}.white,.white a{color:#fff}</style></head><body><nav class="navbar navbar-expand navbar-dark fixed-top bg-dark"><div class=container-fluid><div class=navbar-header><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button></div><div class="collapse navbar-collapse" id=navbarCollapse><ul class="navbar-nav me-auto mb-2 mb-md-0"><li class=nav-item><a class="nav-link active" href=/><i class="bi bi-house-door" style=color:#fff></i>&nbsp;Home</a></li><li class=nav-item><a class="nav-link active" href=/about/><i class="bi bi-signpost-2" style=color:#fff></i>&nbsp;About</a></li><li class=nav-item><a class="nav-link active" href=/posts/><i class="bi bi-card-list" style=color:#fff></i>&nbsp;Blog</a></li><li class=nav-item><a class="nav-link active" href=/tags/><i class="bi bi-tags" style=color:#fff></i>&nbsp;Tags</a></li><li class=nav-item><a class="nav-link active" href=https://github.com/cacoco><i class="bi bi-github" style=color:#fff></i>&nbsp;GitHub</a></li></ul><div class="navbar-text navbar-right"><i class="bi bi-asterisk" style=color:#fff></i><span style=color:#fff>&nbsp;<a href=https://angstrom.io><span>&#229;</span>ngstr<span>&#246;</span>m.io</a>&nbsp;</span></div></div></div></nav><div id=wrap><div class=container-fluid><div class=container><h1 class=mt-5>A Simple Finatra Example Project</h1><p class="text-muted mt-3"><a class=text-muted href=https://angstrom.io/2015/07/12/a-simple-finatra-example-project/>Published July 12, 2015</a>
<a class=text-muted href=/tags/finatra>#Finatra</a>
<a class=text-muted href=/tags/scala>#Scala</a>
<a class=text-muted href=/tags/twitter>#Twitter</a></p><article class="article mt-5"><p>Over the past year-and-a-half I&rsquo;ve helped to develop a <a href=https://www.scala-lang.org/>Scala</a> framework for writing services on-top of parts of the Twitter stack, namely <a href=https://github.com/twitter/twitter-server>TwitterServer</a> and <a href=https://github.com/twitter/finagle>Finagle</a>. This framework is called <a href=https://github.com/twitter/finatra>Finatra</a> and we&rsquo;ve recently published a <a href=https://oss.sonatype.org/#nexus-search;gav~com.twitter.finatra~~2.0.0.M2~~>second milestone release</a> of the completely-rebuilt-from-the-ground-up version 2.x.</p><p>Checkout out the <a href=https://blog.twitter.com/engineering/en_us/a/2015/finatra-20-the-fast-testable-scala-services-framework-that-powers-twitter>blog post</a> announcing the new version with more details on framework features.</p><p>In this post we&rsquo;ll write small <a href=https://github.com/twitter/finatra>Finatra</a> example service; a simple <a href=https://github.com/cacoco/smally-finatra>URL-shortener</a> using <a href=https://redis.io/>Redis</a>. The example builds with <a href=https://www.scala-sbt.org/>sbt</a> and can be easily deployed to <a href=https://heroku.com>Heroku</a>.</p><p>At a high-level, the service accepts JSON input through a POST endpoint that represents the URL to be shortened. It then returns a JSON response with the shortened representation of the URL. The service also then supports GET requests to a shortened URL returning a 301 response to the expanded URL. Browsers will generally follow this redirect by default, so you should be able to just open the shortened URL in a browser window.</p><p>The service uses <a href=https://github.com/xetorthio/jedis>Jedis</a> as a client to Redis.</p><p>First, we set up a server that looks like this:</p><div class=row><div class=col-md-8><script src=https://gist.github.com/cacoco/e6b93886631988350abb.js></script></div></div><p>You&rsquo;ll notice we configure a few <a href=https://github.com/twitter/finatra/blob/master/inject/inject-core/src/main/scala/com/twitter/inject/TwitterModule.scala>modules</a> here. The Finatra <code>LogbackModule</code> which sets <a href=https://logback.qos.ch/><code>logback</code></a> as our logging implementation for <a href=https://www.slf4j.org/>slf4j</a>. A <code>JedisClientModule</code> which configures the Jedis client to talk to a Redis server. And a generic sounding, <code>SmallyModule</code>. The last module defines business-logic configuration for the service. In this case, you can choose to always return <code>https</code> protocol shortened URLs. The <code>SmallyModule</code> defines a flag which you can set on the command line to toggle this behavior. The default is <code>false</code>.</p><p>We then configure the <a href=https://github.com/twitter/finatra/blob/master/http/src/main/scala/com/twitter/finatra/http/routing/HttpRouter.scala><code>HttpRouter</code></a>, setting up a few filters including the Finatra <a href=https://github.com/twitter/finatra/blob/master/http/src/main/scala/com/twitter/finatra/http/filters/CommonFilters.scala><code>CommonFilters</code></a>. We then add the <code>SmallyController</code> and a custom <a href=https://github.com/twitter/finatra/blob/master/http/src/main/scala/com/twitter/finatra/http/exceptions/ExceptionMapper.scala><code>ExceptionMapper</code></a>.</p><p>Now, let&rsquo;s look at the controller:</p><div class=row><div class=col-md-8><script src=https://gist.github.com/cacoco/4abd49ac71e7a2bd3b23.js></script></div></div><p>The controller defines two endpoints: <code>POST(/url)</code> and a <code>GET(/:id)</code>. The <code>POST</code> endpoint accepts JSON input in the form of a <a href=https://github.com/cacoco/smally-finatra/blob/master/src/main/scala/io/angstrom/smally/domain/http/PostUrlRequest.scala><code>PostUrlRequest</code></a> case class:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;url&#34;</span> <span class=p>:</span> <span class=s2>&#34;https://www.google.com&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This endpoint captures the URL posted to the service, storing it in Redis keyed by an atomically increasing Long value. This long value is then converted into a 32-radix String and returned as the path of the shortened URL. The response is an <code>HTTP/1.1 201 Created</code> with a <a href=https://github.com/cacoco/smally-finatra/blob/master/src/main/scala/io/angstrom/smally/domain/http/PostUrlResponse.scala><code>PostUrlResponse</code></a> body:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;smally_url&#34;</span> <span class=p>:</span> <span class=s2>&#34;https://127.0.0.1:8080/9h5k4&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The <code>GET</code> endpoint deferences the id given in the path, looking up the corresponding expanded URL that maps to the Long value represented by the given id. If a mapped URL is found an <code>HTTP 301 Moved Permanently</code> is returned with the expanded URL set in the <code>Location</code> header. Otherwise an <code>HTTP/1.1 404 Not Found</code> is returned for an id that cannot be properly expanded. You can see the various test cases <a href=https://github.com/cacoco/smally-finatra/blob/master/src/test/scala/io/angstrom/smally/SmallyServerFeatureTest.scala>here</a>.</p><p>You&rsquo;ll need to have the <a href=https://toolbelt.heroku.com/>Heroku Toolbelt</a> <a href=https://devcenter.heroku.com/articles/getting-started-with-scala#set-up>installed</a>.</p><p>Clone the <a href=https://github.com/cacoco/smally-finatra><code>smally-finatra</code></a> service locally, and change into the directory, e.g.,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ git clone https://github.com/cacoco/smally-finatra.git
</span></span><span class=line><span class=cl>$ <span class=nb>cd</span> smally-finatra
</span></span></code></pre></div><p>Create a new app in Heroku:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ heroku create
</span></span><span class=line><span class=cl>Creating nameless-lake-8055 in organization heroku... <span class=k>done</span>, stack is cedar-14
</span></span><span class=line><span class=cl>https://nameless-lake-8055.herokuapp.com/ <span class=p>|</span> https://git.heroku.com/nameless-lake-8055.git
</span></span><span class=line><span class=cl>Git remote heroku added
</span></span></code></pre></div><p>Create a Redis add-on:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ heroku addons:create heroku-redis:hobby-dev
</span></span></code></pre></div><p>You can then deploy application to Heroku:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ git push heroku master
</span></span><span class=line><span class=cl>Counting objects: 480, <span class=k>done</span>.
</span></span><span class=line><span class=cl>Delta compression using up to <span class=m>4</span> threads.
</span></span><span class=line><span class=cl>Compressing objects: 100% <span class=o>(</span>376/376<span class=o>)</span>, <span class=k>done</span>.
</span></span><span class=line><span class=cl>Writing objects: 100% <span class=o>(</span>480/480<span class=o>)</span>, 27.68 MiB <span class=p>|</span> 16.24 MiB/s, <span class=k>done</span>.
</span></span><span class=line><span class=cl>Total <span class=m>480</span> <span class=o>(</span>delta 101<span class=o>)</span>, reused <span class=m>0</span> <span class=o>(</span>delta 0<span class=o>)</span>
</span></span><span class=line><span class=cl>remote: Compressing <span class=nb>source</span> files... <span class=k>done</span>.
</span></span><span class=line><span class=cl>remote: Building source:
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>Tail the Heroku logs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ heroku logs -t
</span></span></code></pre></div><p>Then curl the service to create a shortened URL. Once created, paste the returned URL in a browser to be redirected to the expanded URL. To create with curl:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl -i -H <span class=s2>&#34;Content-Type: application/json&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -X POST -d <span class=s1>&#39;{&#34;url&#34;:&#34;https://www.nytimes.com/2012/05/06/travel/36-hours-in-barcelona-spain.html&#34;}&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  https://nameless-lake-8055.herokuapp.com/url
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>201</span> Created
</span></span><span class=line><span class=cl>Content-Type: application/json<span class=p>;</span> <span class=nv>charset</span><span class=o>=</span>utf-8
</span></span><span class=line><span class=cl>Content-Length: <span class=m>44</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;smally_url&#34;</span>:<span class=s2>&#34;https://nameless-lake-8055.herokuapp.com/9h5k4&#34;</span><span class=o>}</span>
</span></span></code></pre></div><p>Full project source available <a href=https://github.com/cacoco/smally-finatra>on github</a>.</p></article></div><div id=push></div><div id=push></div><div class="bg-light py-5"><div class=container><div class=row><div class="col-md-6 text-center"><a class=pull-left href=/2013/11/03/devils-dictionary-of-programming/ title="Devils Dictionary of Programming">&#171; Devils Dictionary of Programming</a></div><div class="col-md-6 text-center"><a class=pull-right href=/2016/02/01/have-twitterserver-will-test/ title="Next Post: Have TwitterServer Will Test">Have TwitterServer Will Test &#187;</a></div></div></div></div></div><div id=push></div></div></body></html>