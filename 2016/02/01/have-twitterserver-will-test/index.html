<!doctype html><html><head><title>Have TwitterServer Will Test</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><link rel=icon href=/images/favicon.ico><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css integrity=sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3 crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js integrity=sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css><style type=text/css>html,body{height:100%;padding-top:30px;padding-bottom:40px}.sidebar-nav{padding-left:18px}.navbar-right{padding-right:18px}#wrap{min-height:100%;height:auto!important;height:100%;margin:0 auto 0}#push,#footer{height:60px}#footer{background-color:#f5f5f5}.white,.white a{color:#fff}</style></head><body><div id=wrap><div class=container-fluid><div class=container><h1 class=mt-5>Have TwitterServer Will Test</h1><p class="text-muted mt-3"><a class=text-muted href=https://angstrom.io/2016/02/01/have-twitterserver-will-test/>Published February 1, 2016</a>
<a class=text-muted href=/tags/twitterserver>#TwitterServer</a>
<a class=text-muted href=/tags/finatra>#finatra</a>
<a class=text-muted href=/tags/scala>#scala</a>
<a class=text-muted href=/tags/twitter>#Twitter</a></p><article class="article mt-5"><p>Did you know you can use <a href=https://twitter.github.io/finatra>Finatra</a>’s <a href=https://twitter.github.io/finatra/user-guide/testing/feature_tests.html>Feature Tests</a> utilities for testing any <a href=https://twitter.github.io/twitter-server/>TwitterServer</a>? That is, you can start a locally running server and write tests which issue requests to it as long the server extends from <code>c.t.server.TwitterServer</code>. It doesn’t specifically have to be a Finatra server.</p><p><a href=https://github.com/twitter/finatra/commit/1878cbd00b20e71651f4b970b3dfb391d26e6d6b>Recent changes</a> to <a href=https://twitter.github.io/finatra>Finatra</a> testing utilities allow for any arbitrary <a href=https://twitter.github.io/twitter-server/>TwitterServer</a> to be able to create <a href=https://twitter.github.io/finatra/user-guide/testing/feature_tests.html>Feature Tests</a> and a very useful type of Feature Test is a simple <a href=https://twitter.github.io/finatra/user-guide/testing/startup_tests.html>Startup Test</a> where you can verify your server starts and is configured how you would expect.</p><p>Some advanced features which require use of injection will not be available but you’ll be able to start the server under test in a controlled environment.</p><p>Here’s an example of writing a test which starts a TwitterServer and asserts that it reports itself “healthy”.</p><p>Given a simple TwitterServer:</p><div class=row><div class=col-md-8><script src=https://gist.github.com/cacoco/fba99528917a17283d1f5f9c3d390585.js></script></div></div><p>A Feature Test which asserts the server starts healthy would look like so:</p><div class=row><div class=col-md-8><script src=https://gist.github.com/cacoco/7a7f957a498b702d478b095ac6a3099d.js></script></div></div><p>Keep in mind that you have the option to explicitly start the server or let the framework start the server. In the example above, the framework will ensure the server under test has started when we call <code>server.isHealthy</code>. Otherwise, we can add a <code>beforeAll()</code> which will explicitly start the server.</p><div class=row><div class=col-md-8><script src=https://gist.github.com/cacoco/0768394ecf9a6e352ba1d3a5ab43a5e6.js></script></div></div><p>Note, if you have <a href=https://twitter.github.io/finagle/guide/Clients.html>Finagle clients</a> defined in your server and want to keep them from making remote connections when your server starts you can override the dtab of the clients by passing the <code>dtab.add</code> flag to your server under test:</p><div class=row><div class=col-md-8><script src=https://gist.github.com/cacoco/47ff96165061682322ab728a8ec9ed9a.js></script></div></div><p>To create a client to your server under test, you’ll need the bound port of the server (which is only bound after the server is started and thus you’ll want to delay the client creation until the server has started). You can easily obtain the bound port for the TwitterServer <a href=https://twitter.github.io/twitter-server/Admin.html>HTTP Admin Interface</a> directly via <code>EmbeddedTwitterServer#httpAdminPort</code>.</p><p>You could then create a Finagle HTTP client to the TwitterServer admin:</p><div class=row><div class=col-md-8><script src=https://gist.github.com/cacoco/32db7fc43768b58de1900aa1c163ce93.js></script></div></div><p>To get the bound external port of the server under test, you’ll need to structure your code to expose it for your test to be able to read once the server has been started. That is, the ListeningServer started in your server <code>main</code> needs to be exposed such that you can call <code>server.boundAddress</code>.</p><p>This is where using the Finatra <a href=https://twitter.github.io/finatra/user-guide/http/server.html><code>HttpServer</code></a> or <a href=https://twitter.github.io/finatra/user-guide/thrift/server.html><code>ThriftServer</code></a> can help as much of the client creation work can then be done for you by the framework.</p></article></div><div id=push></div><div id=push></div><div class="container mt-5"><h2 class=text-center>See also</h2><div class=row><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=/2015/07/12/a-simple-finatra-example-project/>A Simple Finatra Example Project</a></p><p class="font-weight-light mt-3">Over the past year-and-a-half I&rsquo;ve helped to develop a Scala framework for writing services on-top of parts of the Twitter stack, namely TwitterServer and Finagle. This framework is called Finatra and we&rsquo;ve recently published a second milestone release of the completely-rebuilt-from-the-ground-up version 2.x.
Checkout out the blog post announcing the new version with more details on framework features.
In this post we&rsquo;ll write small Finatra example service; a simple URL-shortener using Redis.</p><a href=/2015/07/12/a-simple-finatra-example-project/ class="btn btn-primary">Read more</a></div><div class="col-md mb-3"><p class="lead mb-0"><a class=text-body href=/2013/02/12/accumulator-generator-in-scala/>Accumulator Generator in Scala</a></p><p class="font-weight-light mt-3">The Problem https://www.paulgraham.com/accgen.html
The Solution</p><a href=/2013/02/12/accumulator-generator-in-scala/ class="btn btn-primary">Read more</a></div></div></div><div class="bg-light py-5"><div class=container><div class=row><div class="col-md-6 text-center"><a class=pull-left href=/2015/07/12/a-simple-finatra-example-project/ title="A Simple Finatra Example Project">&#171; A Simple Finatra Example Project</a></div><div class="col-md-6 text-center"><a class=pull-right href=/2023/02/03/foggy-city/ title="Next Post: Foggy City">Foggy City &#187;</a></div></div></div></div></div><div id=push></div></div></body></html>